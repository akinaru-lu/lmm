version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - run:
          name: Setup docker-compose
          command: |
            pip install --upgrade pip
            pip install docker-compose
      - run:
          name: Setup API
          command: |
            cd api
            chmod -R 777 mysql
            mkdir -p .env
            echo LMM_API_TOKEN_KEY=$(uuidgen | sed -e 's/-//g') > .env/test.env
            make install
            make build
      - run:
          name: Test API
          command: |
            cd api
            make test
      - run:
          name: Test API CLI
          command: |
            cd api
            make cli env=dev commands="hello-world"
