version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - restore_cache:
          keys:
            - docker-{{ checksum "api/docker-compose.yml" }}
            - api-{{ checksum ".circleci/config.yml" }}-{{ checksum "api/go/src/lmm/api/go.mod" }}
      - run:
          name: Setup docker-compose
          command: |
            pip install --upgrade pip
            pip install docker-compose
      - run:
          name: Setup API
          command: |
            cd api
            chmod -R 777 mysql
            mkdir -p .env
            echo LMM_API_TOKEN_KEY=$(uuidgen | sed -e 's/-//g') > .env/test.env
            make install
            make build
      - save_cache:
          key: api-{{ checksum ".circleci/config.yml" }}-{{ checksum "api/go/src/lmm/api/go.mod" }}
          paths:
            - api/go/pkg/mod/cache
      - save_cache:
          name: API docker images
          key: docker-{{ checksum "api/docker-compose.yml" }}
          paths:
            - ~/caches/images.tar
      - run:
          name: Test API
          command: |
            cd api
            make test
      - run:
          name: Test API CLI
          command: |
            cd api
            make cli env=test commands="hello-world"
